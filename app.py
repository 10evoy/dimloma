import streamlit as st
import json
import pandas as pd
from task_selector import TaskSelector, TOPICS

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π",
    page_icon="üìä",
    layout="wide"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π")
st.markdown("""
–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è 
–¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ 7-9 –∫–ª–∞—Å—Å–æ–≤ –ø–æ —Ç–µ–æ—Ä–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò.
""")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∑–∞–¥–∞—á
@st.cache_resource
def get_task_selector():
    return TaskSelector()

task_selector = get_task_selector()

# –°–æ–∑–¥–∞–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
with st.sidebar:
    st.header("–î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞")
    
    # –í—ã–±–æ—Ä —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã
    current_topic = st.selectbox(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Ç–µ–º—É",
        options=TOPICS
    )
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á
    num_tasks = st.slider(
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á",
        min_value=1,
        max_value=10,
        value=5
    )
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
    generate_button = st.button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏", type="primary")

# –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å - –≤–≤–æ–¥ –æ—Ü–µ–Ω–æ–∫
st.header("–û—Ü–µ–Ω–∫–∏ —É—á–µ–Ω–∏–∫–∞")

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ü–µ–Ω–æ–∫
marks_data = {}
possible_marks = ["–µ—â—ë –Ω–µ –∏–∑—É—á–∞–ª", "2", "3", "4", "5"]

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
col1, col2 = st.columns(2)

for i, topic in enumerate(TOPICS):
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
    col = col1 if i < len(TOPICS) // 2 else col2
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–±–æ–∫—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã
    with col:
        mark = st.selectbox(
            f"{topic}",
            options=possible_marks,
            key=f"mark_{i}"
        )
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤–æ–π –æ—Ü–µ–Ω–∫–∏ –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
        if mark in ["2", "3", "4", "5"]:
            marks_data[topic] = int(mark)
        else:
            marks_data[topic] = mark

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
if generate_button:
    st.header("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞
    student_data = task_selector.create_student_data(current_topic, marks_data)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á
    with st.spinner("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á..."):
        tasks = task_selector.get_tasks_for_student(student_data, num_tasks=num_tasks)
    
    if tasks:
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á
        for i, task in enumerate(tasks, 1):
            with st.expander(f"–ó–∞–¥–∞—á–∞ {i}: {task['—É—Å–ª–æ–≤–∏–µ'][:100]}...", expanded=True):
                st.markdown(f"**–£—Å–ª–æ–≤–∏–µ:** {task['—É—Å–ª–æ–≤–∏–µ']}")
                st.markdown(f"**–¢–µ–º–∞:** {task['—Ç–µ–º–∞']}")
                st.markdown(f"**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** {task['—Å–ª–æ–∂–Ω–æ—Å—Ç—å']}")
                st.markdown(f"**–¢–∏–ø:** {task['—Ç–∏–ø']}")
                
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                if st.button(f"–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç –∫ –∑–∞–¥–∞—á–µ {i}", key=f"answer_{i}"):
                    st.markdown(f"**–û—Ç–≤–µ—Ç:** {task['–æ—Ç–≤–µ—Ç']}")
    else:
        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
st.markdown("---")
st.markdown("""
### –û –ø—Ä–æ–µ–∫—Ç–µ
–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö –º–∞–≥–∏—Å—Ç–µ—Ä—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ —Ç–µ–º–µ 
"–ú–µ—Ç–æ–¥–∏–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –æ–±—É—á–µ–Ω–∏—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ 7-9 –∫–ª–∞—Å—Å–æ–≤ 
—Ç–µ–æ—Ä–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞".

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- –î–∞–Ω–Ω—ã–µ –æ–± —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ —É—á–µ–Ω–∏–∫–∞
- –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
- –ë–∞–∑—É –∏–∑ 1200 –∑–∞–¥–∞—á –ø–æ —Ç–µ–æ—Ä–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
""")